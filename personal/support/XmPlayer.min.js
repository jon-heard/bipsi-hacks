function le_word(t,e){return t[e]|t[e+1]<<8}function le_dword(t,e){return t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24}function s_byte(t,e){return t[e]<128?t[e]:t[e]-256}function s_le_word(t,e){return le_word(t,e)<32768?le_word(t,e):le_word(t,e)-65536}function dos2utf(t){if(t<128)return String.fromCharCode(t);return String.fromCharCode([199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,248,163,216,215,402,225,237,243,250,241,209,170,186,191,174,172,189,188,161,171,187,9617,9618,9619,9474,9508,193,194,192,169,9571,9553,9559,9565,162,165,9488,9492,9524,9516,9500,9472,9532,227,195,9562,9556,9577,9574,9568,9552,9580,164,240,208,202,203,200,305,205,206,207,9496,9484,9608,9604,166,204,9600,211,223,212,210,245,213,181,254,222,218,219,217,253,221,175,180,173,177,8215,190,182,167,247,184,176,168,183,185,179,178,9632,160][t-128])}function Modplayer(){this.supportedformats=new Array("xm"),this.url="",this.format="s3m",this.state="initializing..",this.request=null,this.loading=!1,this.playing=!1,this.paused=!1,this.repeat=!1,this.separation=1,this.mixval=8,this.amiga500=!1,this.filter=!1,this.endofsong=!1,this.autostart=!1,this.bufferstodelay=4,this.delayfirst=0,this.delayload=0,this.onReady=function(){},this.onFailure=function(t){},this.onPlay=function(){},this.onStop=function(){},this.onSongPatternChange=null,this.onSongEnd=null,this.onSongRowChange=null,this.onSongEffect=null,this.buffer=0,this.mixerNode=0,this.context=null,this.samplerate=44100,this.bufferlen=4096,this.chvu=new Float32Array(32),this.player=null,this.title="",this.signature="....",this.songlen=0,this.channels=0,this.patterns=0,this.samplenames=new Array}function Fasttracker(t){var e,n;for(this.songEventListener=t,this.clearsong(),this.initialize(),this.playing=!1,this.paused=!1,this.repeat=!1,this.filter=!1,this.syncqueue=[],this.samplerate=44100,this.ramplen=64,this.mixval=8,this.periodtable=new Float32Array([907,900,894,887,881,875,868,862,856,850,844,838,832,826,820,814,808,802,796,791,785,779,774,768,762,757,752,746,741,736,730,725,720,715,709,704,699,694,689,684,678,675,670,665,660,655,651,646,640,636,632,628,623,619,614,610,604,601,597,592,588,584,580,575,570,567,563,559,555,551,547,543,538,535,532,528,524,520,516,513,508,505,502,498,494,491,487,484,480,477,474,470,467,463,460,457,453,450,447,445,442,439,436,433,428]),this.pan=new Float32Array(32),this.finalpan=new Float32Array(32),e=0;e<32;e++)this.pan[e]=this.finalpan[e]=.5;for(this.vibratotable=new Array,n=0;n<4;n++)for(this.vibratotable[n]=new Float32Array(64),e=0;e<64;e++)switch(n){case 0:this.vibratotable[n][e]=127*Math.sin(2*Math.PI*(e/64));break;case 1:this.vibratotable[n][e]=127-4*e;break;case 2:this.vibratotable[n][e]=e<32?127:-127;break;case 3:this.vibratotable[n][e]=127*(1-2*Math.random())}this.voleffects_t0=new Array(this.effect_vol_t0_f0,this.effect_vol_t0_60,this.effect_vol_t0_70,this.effect_vol_t0_80,this.effect_vol_t0_90,this.effect_vol_t0_a0,this.effect_vol_t0_b0,this.effect_vol_t0_c0,this.effect_vol_t0_d0,this.effect_vol_t0_e0),this.voleffects_t1=new Array(this.effect_vol_t1_f0,this.effect_vol_t1_60,this.effect_vol_t1_70,this.effect_vol_t1_80,this.effect_vol_t1_90,this.effect_vol_t1_a0,this.effect_vol_t1_b0,this.effect_vol_t1_c0,this.effect_vol_t1_d0,this.effect_vol_t1_e0),this.effects_t0=new Array(this.effect_t0_0,this.effect_t0_1,this.effect_t0_2,this.effect_t0_3,this.effect_t0_4,this.effect_t0_5,this.effect_t0_6,this.effect_t0_7,this.effect_t0_8,this.effect_t0_9,this.effect_t0_a,this.effect_t0_b,this.effect_t0_c,this.effect_t0_d,this.effect_t0_e,this.effect_t0_f,this.effect_t0_g,this.effect_t0_h,this.effect_t0_i,this.effect_t0_j,this.effect_t0_k,this.effect_t0_l,this.effect_t0_m,this.effect_t0_n,this.effect_t0_o,this.effect_t0_p,this.effect_t0_q,this.effect_t0_r,this.effect_t0_s,this.effect_t0_t,this.effect_t0_u,this.effect_t0_v,this.effect_t0_w,this.effect_t0_x,this.effect_t0_y,this.effect_t0_z),this.effects_t0_e=new Array(this.effect_t0_e0,this.effect_t0_e1,this.effect_t0_e2,this.effect_t0_e3,this.effect_t0_e4,this.effect_t0_e5,this.effect_t0_e6,this.effect_t0_e7,this.effect_t0_e8,this.effect_t0_e9,this.effect_t0_ea,this.effect_t0_eb,this.effect_t0_ec,this.effect_t0_ed,this.effect_t0_ee,this.effect_t0_ef),this.effects_t1=new Array(this.effect_t1_0,this.effect_t1_1,this.effect_t1_2,this.effect_t1_3,this.effect_t1_4,this.effect_t1_5,this.effect_t1_6,this.effect_t1_7,this.effect_t1_8,this.effect_t1_9,this.effect_t1_a,this.effect_t1_b,this.effect_t1_c,this.effect_t1_d,this.effect_t1_e,this.effect_t1_f,this.effect_t1_g,this.effect_t1_h,this.effect_t1_i,this.effect_t1_j,this.effect_t1_k,this.effect_t1_l,this.effect_t1_m,this.effect_t1_n,this.effect_t1_o,this.effect_t1_p,this.effect_t1_q,this.effect_t1_r,this.effect_t1_s,this.effect_t1_t,this.effect_t1_u,this.effect_t1_v,this.effect_t1_w,this.effect_t1_x,this.effect_t1_y,this.effect_t1_z),this.effects_t1_e=new Array(this.effect_t1_e0,this.effect_t1_e1,this.effect_t1_e2,this.effect_t1_e3,this.effect_t1_e4,this.effect_t1_e5,this.effect_t1_e6,this.effect_t1_e7,this.effect_t1_e8,this.effect_t1_e9,this.effect_t1_ea,this.effect_t1_eb,this.effect_t1_ec,this.effect_t1_ed,this.effect_t1_ee,this.effect_t1_ef)}Modplayer.prototype.load=function(t){this.url=t;var e=t.split(".").pop().toLowerCase().trim();if(-1==this.supportedformats.indexOf(e)&&(e=t.split("/").pop().split(".").shift().toLowerCase().trim(),-1==this.supportedformats.indexOf(e)))return this.onFailure("filetype"),!1;if(this.format=e,"xm"===e)this.player=new Fasttracker(this);this.player.onReady=this.loadSuccess,this.state="loading..";var n=new XMLHttpRequest;n.open("GET",this.url,!0),n.responseType="arraybuffer",this.request=n,this.loading=!0;var a=this;return n.onprogress=function(t){a.state="loading ("+Math.floor(100*t.loaded/t.total)+"%).."},n.onerror=function(){a.state="error!",a.loading=!1,a.onFailure("http")},n.onload=function(){if(n.status<200||n.status>299)return a.state="error!",a.loading=!1,void a.onFailure("http");var t=new Uint8Array(n.response);if(this.state="parsing..",a.player.parse(t)){for(a.title=a.player.title,a.signature=a.player.signature,a.songlen=a.player.songlen,a.channels=a.player.channels,a.patterns=a.player.patterns,a.filter=a.player.filter,a.context&&a.setfilter(a.filter),a.mixval=a.player.mixval,a.samplenames=new Array(32),i=0;i<32;i++)a.samplenames[i]="";if("xm"==a.format||"it"==a.format)for(i=0;i<a.player.instrument.length;i++)a.samplenames[i]=a.player.instrument[i].name;else for(i=0;i<a.player.sample.length;i++)a.samplenames[i]=a.player.sample[i].name;a.state="ready.",a.loading=!1,a.onReady(),a.autostart&&a.play()}else a.state="error!",a.loading=!1,a.onFailure("parser")},n.send(),!0},Modplayer.prototype.play=function(){if(this.loading)return!1;if(this.player){if(null==this.context&&this.createContext(),this.player.samplerate=this.samplerate,this.context&&this.setfilter(this.player.filter),this.player.paused)return this.player.paused=!1,!0;for(this.endofsong=!1,this.player.endofsong=!1,this.player.paused=!1,this.player.initialize(),this.player.flags=3,this.player.playing=!0,this.playing=!0,this.chvu=new Float32Array(this.player.channels),i=0;i<this.player.channels;i++)this.chvu[i]=0;return this.onPlay(),this.player.delayfirst=this.bufferstodelay,!0}return!1},Modplayer.prototype.pause=function(){this.player&&(this.player.paused?this.player.paused=!1:this.player.paused=!0)},Modplayer.prototype.stop=function(){this.paused=!1,this.playing=!1,this.player&&(this.player.paused=!1,this.player.playing=!1,this.player.delayload=1),this.onStop()},Modplayer.prototype.stopaudio=function(t){this.player&&(this.player.playing=t)},Modplayer.prototype.jump=function(t){this.player&&(this.player.tick=0,this.player.row=0,this.player.position+=t,this.player.flags=3,this.player.position<0&&(this.player.position=0),this.player.position>=this.player.songlen&&this.stop()),this.position=this.player.position,this.row=this.player.row},Modplayer.prototype.setrepeat=function(t){this.repeat=t,this.player&&(this.player.repeat=t)},Modplayer.prototype.setseparation=function(t){this.separation=t,this.player&&(this.player.separation=t)},Modplayer.prototype.setautostart=function(t){this.autostart=t},Modplayer.prototype.setamigamodel=function(t){"600"==t||"1200"==t||"4000"==t?(this.amiga500=!1,this.filterNode&&(this.filterNode.frequency.value=22050)):(this.amiga500=!0,this.filterNode&&(this.filterNode.frequency.value=6e3))},Modplayer.prototype.setfilter=function(t){this.lowpassNode.frequency.value=t?3275:28867,this.filter=t,this.player&&(this.player.filter=t)},Modplayer.prototype.hassyncevents=function(){return!!this.player&&0!=this.player.syncqueue.length},Modplayer.prototype.popsyncevent=function(){if(this.player)return this.player.syncqueue.pop()},Modplayer.prototype.currentpattern=function(){if(this.player)return this.player.patterntable[this.player.position]},Modplayer.prototype.patterndata=function(t){var e,n,a;if("mod"==this.format)for(a=new Uint8Array(this.player.pattern_unpack[t]),e=0;e<64;e++)for(n=0;n<this.player.channels;n++)0==a[5*e*this.channels+5*n+3]&&0==a[5*e*this.channels+5*n+4]?a[5*e*this.channels+5*n+3]=46:(a[5*e*this.channels+5*n+3]+=55,a[5*e*this.channels+5*n+3]<65&&(a[5*e*this.channels+5*n+3]-=7));else if("s3m"==this.format)for(a=new Uint8Array(this.player.pattern[t]),e=0;e<64;e++)for(n=0;n<this.player.channels;n++)255==a[5*e*this.channels+5*n+3]?a[5*e*this.channels+5*n+3]=46:a[5*e*this.channels+5*n+3]+=64;else if("xm"==this.format)for(a=new Uint8Array(this.player.pattern[t]),e=0;e<this.player.patternlen[t];e++)for(n=0;n<this.player.channels;n++)a[5*e*this.channels+5*n+0]<97&&(a[5*e*this.channels+5*n+0]=a[5*e*this.channels+5*n+0]%12|Math.floor(a[5*e*this.channels+5*n+0]/12)<<4),255==a[5*e*this.channels+5*n+3]?a[5*e*this.channels+5*n+3]=46:a[5*e*this.channels+5*n+3]<10?a[5*e*this.channels+5*n+3]+=48:a[5*e*this.channels+5*n+3]+=55;return a},Modplayer.prototype.noteon=function(t){return t>=this.channels?0:this.player.channel[t].noteon},Modplayer.prototype.currentsample=function(t){return t>=this.channels?0:"xm"==this.format||"it"==this.format?this.player.channel[t].instrument:this.player.channel[t].sample},Modplayer.prototype.currentpattlen=function(){return"mod"==this.format||"s3m"==this.format?64:this.player.patternlen[this.player.patterntable[this.player.position]]},Modplayer.prototype.createContext=function(){"undefined"!=typeof AudioContext?this.context=new AudioContext:this.context=new webkitAudioContext,this.samplerate=this.context.sampleRate,this.bufferlen=this.samplerate>44100?4096:2048,this.filterNode=this.context.createBiquadFilter(),this.amiga500?this.filterNode.frequency.value=6e3:this.filterNode.frequency.value=22050,this.lowpassNode=this.context.createBiquadFilter(),this.setfilter(this.filter),"function"==typeof this.context.createJavaScriptNode?this.mixerNode=this.context.createJavaScriptNode(this.bufferlen,1,2):this.mixerNode=this.context.createScriptProcessor(this.bufferlen,1,2),this.mixerNode.module=this,this.mixerNode.onaudioprocess=Modplayer.prototype.mix,this.mixerNode.connect(this.filterNode),this.filterNode.connect(this.lowpassNode),this.lowpassNode.connect(this.context.destination)},Modplayer.prototype.mix=function(e){var n;if((n=e.srcElement?e.srcElement.module:this.module).player&&0==n.delayfirst){n.player.repeat=n.repeat;var a=new Array(e.outputBuffer.getChannelData(0),e.outputBuffer.getChannelData(1)),i=e.outputBuffer.length;n.player.mix(n.player,a,i);for(var s=new Float32Array(2),o=0;o<i;o++)s[0]=a[0][o],s[1]=a[1][o],n.separation&&(t=s[0],2==n.separation?(s[0]=.5*s[0]+.5*s[1],s[1]=.5*s[1]+.5*t):(s[0]=.65*s[0]+.35*s[1],s[1]=.65*s[1]+.35*t)),s[0]/=n.mixval,s[0]=.5*(Math.abs(s[0]+.975)-Math.abs(s[0]-.975)),s[1]/=n.mixval,s[1]=.5*(Math.abs(s[1]+.975)-Math.abs(s[1]-.975)),a[0][o]=s[0],a[1][o]=s[1];n.row=n.player.row,n.position=n.player.position,n.speed=n.player.speed,n.bpm=n.player.bpm,n.endofsong=n.player.endofsong,n.player.filter!=n.filter&&n.setfilter(n.player.filter),n.endofsong&&n.playing&&n.stop(),n.delayfirst>0&&n.delayfirst--,n.delayload=0;for(var r=0;r<n.player.channels;r++)n.chvu[r]=.25*n.chvu[r]+.75*n.player.chvu[r],n.player.chvu[r]=0}},Fasttracker.prototype.clearsong=function(){var t;for(this.title="",this.signature="",this.trackerversion=260,this.songlen=1,this.repeatpos=0,this.channels=0,this.patterns=0,this.instruments=32,this.amigaperiods=0,this.initSpeed=6,this.initBPM=125,this.patterntable=new ArrayBuffer(256),t=0;t<256;t++)this.patterntable[t]=0;for(this.pattern=new Array,this.instrument=new Array(this.instruments),t=0;t<32;t++)this.instrument[t]=new Object,this.instrument[t].name="",this.instrument[t].samples=new Array;this.chvu=new Float32Array(2)},Fasttracker.prototype.initialize=function(){for(this.syncqueue=[],this.tick=-1,this.position=0,this.row=0,this.flags=0,this.volume=64,this.initSpeed&&(this.speed=this.initSpeed),this.initBPM&&(this.bpm=this.initBPM),this.stt=0,this.breakrow=0,this.patternjump=0,this.patterndelay=0,this.patternwait=0,this.endofsong=!1,this.looprow=0,this.loopstart=0,this.loopcount=0,this.globalvolslide=0,this.channel=new Array,i=0;i<this.channels;i++)this.channel[i]=new Object,this.channel[i].instrument=0,this.channel[i].sampleindex=0,this.channel[i].note=36,this.channel[i].command=0,this.channel[i].data=0,this.channel[i].samplepos=0,this.channel[i].samplespeed=0,this.channel[i].flags=0,this.channel[i].noteon=0,this.channel[i].volslide=0,this.channel[i].slidespeed=0,this.channel[i].slideto=0,this.channel[i].slidetospeed=0,this.channel[i].arpeggio=0,this.channel[i].period=640,this.channel[i].frequency=8363,this.channel[i].volume=64,this.channel[i].voiceperiod=0,this.channel[i].voicevolume=0,this.channel[i].finalvolume=0,this.channel[i].semitone=12,this.channel[i].vibratospeed=0,this.channel[i].vibratodepth=0,this.channel[i].vibratopos=0,this.channel[i].vibratowave=0,this.channel[i].volramp=1,this.channel[i].volrampfrom=0,this.channel[i].volenvpos=0,this.channel[i].panenvpos=0,this.channel[i].fadeoutpos=0,this.channel[i].playdir=1,this.channel[i].volramp=0,this.channel[i].volrampfrom=0,this.channel[i].trigramp=0,this.channel[i].trigrampfrom=0,this.channel[i].currentsample=0,this.channel[i].lastsample=0,this.channel[i].oldfinalvolume=0,this.channel[i].interactiveMute=!1,this.channel[i].interactiveVolume=1},Fasttracker.prototype.parse=function(t){var e,n,a,i,s,o,r;if(!t)return!1;for(e=0;e<17;e++)this.signature+=String.fromCharCode(t[e]);if("Extended Module: "!=this.signature)return!1;if(26!=t[37])return!1;if(this.signature="X.M.",this.trackerversion=le_word(t,58),this.trackerversion<260)return!1;for(e=0;t[e]&&e<20;)this.title+=dos2utf(t[17+e++]);r=le_dword(t,s=60),this.songlen=le_word(t,s+4),this.repeatpos=le_word(t,s+6),this.channels=le_word(t,s+8),this.patterns=le_word(t,s+10),this.instruments=le_word(t,s+12),this.amigaperiods=1&!le_word(t,s+14),this.initSpeed=le_word(t,s+16),this.initBPM=le_word(t,s+18);var l=0;for(e=0;e<256;e++)this.patterntable[e]=t[s+20+e],this.patterntable[e]>l&&(l=this.patterntable[e]);for(l++,this.pattern=new Array(l),this.patternlen=new Array(l),e=0;e<l;e++)for(this.patternlen[e]=64,this.pattern[e]=new Uint8Array(this.channels*this.patternlen[e]*5),row=0;row<this.patternlen[e];row++)for(ch=0;ch<this.channels;ch++)this.pattern[e][row*this.channels*5+5*ch+0]=255,this.pattern[e][row*this.channels*5+5*ch+1]=0,this.pattern[e][row*this.channels*5+5*ch+2]=255,this.pattern[e][row*this.channels*5+5*ch+3]=255,this.pattern[e][row*this.channels*5+5*ch+4]=0;for(s+=r,e=0;e<this.patterns;){for(this.patternlen[e]=le_word(t,s+5),this.pattern[e]=new Uint8Array(this.channels*this.patternlen[e]*5),a=0;a<this.patternlen[e]*this.channels;a++)this.pattern[e][5*a+0]=0,this.pattern[e][5*a+1]=0,this.pattern[e][5*a+2]=0,this.pattern[e][5*a+3]=0,this.pattern[e][5*a+4]=0;for(o=le_word(t,s+7),s+=le_dword(t,s),n=0,a=0;n<o;)128&(i=t[s+n++])?(1&i&&(this.pattern[e][a+0]=t[s+n++]),2&i&&(this.pattern[e][a+1]=t[s+n++]),4&i&&(this.pattern[e][a+2]=t[s+n++]),8&i&&(this.pattern[e][a+3]=t[s+n++]),16&i&&(this.pattern[e][a+4]=t[s+n++])):(this.pattern[e][a+0]=i,this.pattern[e][a+1]=t[s+n++],this.pattern[e][a+2]=t[s+n++],this.pattern[e][a+3]=t[s+n++],this.pattern[e][a+4]=t[s+n++]),a+=5;for(a=0;a<this.patternlen[e]*this.channels*5;a+=5)this.pattern[e][a+0]>=97?this.pattern[e][a+0]=254:0==this.pattern[e][a+0]?this.pattern[e][a+0]=255:this.pattern[e][a+0]--,0==this.pattern[e][a+3]&&0==this.pattern[e][a+4]&&(this.pattern[e][a+3]=255),this.pattern[e][a+2]<16?this.pattern[e][a+2]=255:this.pattern[e][a+2]>=16&&this.pattern[e][a+2]<=80?this.pattern[e][a+2]-=16:this.pattern[e][a+2]>=240&&(this.pattern[e][a+2]-=160);s+=n,e++}for(this.patterns=l,this.instrument=new Array(this.instruments),e=0;e<this.instruments;){for(r=le_dword(t,s),this.instrument[e]=new Object,this.instrument[e].sample=new Array,this.instrument[e].name="",n=0;t[s+4+n]&&n<22;)this.instrument[e].name+=dos2utf(t[s+4+n++]);for(this.instrument[e].samples=le_word(t,s+27),this.instrument[e].samplemap=new Uint8Array(96),n=0;n<96;n++)this.instrument[e].samplemap[n]=0;for(this.instrument[e].volenv=new Float32Array(325),this.instrument[e].panenv=new Float32Array(325),this.instrument[e].voltype=0,this.instrument[e].pantype=0,n=0;n<=this.instrument[e].samples;n++)this.instrument[e].sample[n]={bits:8,stereo:0,bps:1,length:0,loopstart:0,looplength:0,loopend:0,looptype:0,volume:64,finetune:0,relativenote:0,panning:128,name:"",data:new Float32Array(0)};if(this.instrument[e].samples){var c=le_dword(t,s+29);for(n=0;n<96;n++)this.instrument[e].samplemap[n]=t[s+33+n];var h=new Array(12),p=new Array(12);for(n=0;n<12;n++)h[n]=new Uint16Array([le_word(t,s+129+4*n),le_word(t,s+129+4*n+2)]),p[n]=new Uint16Array([le_word(t,s+177+4*n),le_word(t,s+177+4*n+2)]);for(this.instrument[e].voltype=t[s+233],this.instrument[e].pantype=t[s+234],n=0;n<325;n++)this.instrument[e].volenv[n]=1;if(1&this.instrument[e].voltype){for(n=0;n<325;n++){for(f=1;h[f][0]<n&&f<11;)f++;u=h[f][0]==h[f-1][0]?0:(h[f][1]-h[f-1][1])/(h[f][0]-h[f-1][0]),this.instrument[e].volenv[n]=(h[f-1][1]+u*(n-h[f-1][0]))/64}this.instrument[e].volenvlen=h[Math.max(0,t[s+225]-1)][0],this.instrument[e].volsustain=h[t[s+227]][0],this.instrument[e].volloopstart=h[t[s+228]][0],this.instrument[e].volloopend=h[t[s+229]][0]}for(n=0;n<325;n++)this.instrument[e].panenv[n]=.5;if(1&this.instrument[e].pantype){for(n=0;n<325;n++){var f,u;for(f=1;p[f][0]<n&&f<11;)f++;u=p[f][0]==p[f-1][0]?0:(p[f][1]-p[f-1][1])/(p[f][0]-p[f-1][0]),this.instrument[e].panenv[n]=(p[f-1][1]+u*(n-p[f-1][0]))/64}this.instrument[e].panenvlen=p[Math.max(0,t[s+226]-1)][0],this.instrument[e].pansustain=p[t[s+230]][0],this.instrument[e].panloopstart=p[t[s+231]][0],this.instrument[e].panloopend=p[t[s+232]][0]}for(this.instrument[e].vibratotype=t[s+235],this.instrument[e].vibratosweep=t[s+236],this.instrument[e].vibratodepth=t[s+237],this.instrument[e].vibratorate=t[s+238],this.instrument[e].volfadeout=le_word(t,s+239),s+=r,this.instrument[e].sample=new Array(this.instrument[e].samples),n=0;n<this.instrument[e].samples;n++){for(o=le_dword(t,s+0),this.instrument[e].sample[n]=new Object,this.instrument[e].sample[n].bits=16&t[s+14]?16:8,this.instrument[e].sample[n].stereo=0,this.instrument[e].sample[n].bps=16==this.instrument[e].sample[n].bits?2:1,this.instrument[e].sample[n].length=o/this.instrument[e].sample[n].bps,this.instrument[e].sample[n].loopstart=le_dword(t,s+4)/this.instrument[e].sample[n].bps,this.instrument[e].sample[n].looplength=le_dword(t,s+8)/this.instrument[e].sample[n].bps,this.instrument[e].sample[n].loopend=this.instrument[e].sample[n].loopstart+this.instrument[e].sample[n].looplength,this.instrument[e].sample[n].looptype=3&t[s+14],this.instrument[e].sample[n].volume=t[s+12],t[s+13]<128?this.instrument[e].sample[n].finetune=t[s+13]:this.instrument[e].sample[n].finetune=t[s+13]-256,t[s+16]<128?this.instrument[e].sample[n].relativenote=t[s+16]:this.instrument[e].sample[n].relativenote=t[s+16]-256,this.instrument[e].sample[n].panning=t[s+15],a=0,this.instrument[e].sample[n].name="";t[s+18+a]&&a<22;)this.instrument[e].sample[n].name+=dos2utf(t[s+18+a++]);s+=c}for(n=0;n<this.instrument[e].samples;n++){if(this.instrument[e].sample[n].data=new Float32Array(this.instrument[e].sample[n].length),i=0,16==this.instrument[e].sample[n].bits)for(a=0;a<this.instrument[e].sample[n].length;a++)(i+=s_le_word(t,s+2*a))<-32768&&(i+=65536),i>32767&&(i-=65536),this.instrument[e].sample[n].data[a]=i/32768;else for(a=0;a<this.instrument[e].sample[n].length;a++)(i+=s_byte(t,s+a))<-128&&(i+=256),i>127&&(i-=256),this.instrument[e].sample[n].data[a]=i/128;s+=this.instrument[e].sample[n].length*this.instrument[e].sample[n].bps}}else s+=r;e++}for(this.mixval=4-this.channels/32*2,this.chvu=new Float32Array(this.channels),e=0;e<this.channels;e++)this.chvu[e]=0;return!0},Fasttracker.prototype.calcperiod=function(t,e,n){var a;if(t.amigaperiods){var i=Math.floor(n/16),s=t.periodtable[8+e%12*8+i],o=t.periodtable[8+e%12*8+i+1];a=((1-(i=n/16-i))*s+i*o)*(16/Math.pow(2,Math.floor(e/12)-1))}else a=7680-64*e-n/2;return a},Fasttracker.prototype.advance=function(t){t.stt=Math.floor(125/t.bpm*.02*t.samplerate),t.tick++,t.flags|=1,t.tick>=t.speed&&(t.patterndelay?t.tick<(t.patternwait+1)*t.speed?t.patternwait++:(t.row++,t.tick=0,t.flags|=2,t.patterndelay=0):112&t.flags?(64&t.flags?(t.row=t.looprow,t.flags&=161,t.flags|=2):16&t.flags&&(t.position=t.patternjump,t.row=t.breakrow,t.patternjump=0,t.breakrow=0,t.flags&=225,t.flags|=2),t.tick=0):(t.row++,t.tick=0,t.flags|=2),this.songEventListener.onSongRowChange?.()),t.row>=t.patternlen[t.patterntable[t.position]]&&(t.position++,t.row=0,t.flags|=4,this.songEventListener.onSongPatternChange?.()),t.position>=t.songlen&&(t.repeat?(t.position=0,this.songEventListener.onSongEnd?.(!0)):(this.endofsong=!0,this.songEventListener.onSongEnd?.(!1)))},Fasttracker.prototype.process_note=function(t,e,n){var a,i,s,o,r,l;if(r=5*t.row*t.channels+5*n,a=t.pattern[e][r],(i=t.pattern[e][r+1])&&i<=t.instrument.length&&(t.channel[n].instrument=i-1,t.instrument[i-1].samples&&(s=t.instrument[i-1].samplemap[t.channel[n].note],t.channel[n].sampleindex=s,t.channel[n].volume=t.instrument[i-1].sample[s].volume,t.channel[n].playdir=1,t.pan[n]=t.instrument[i-1].sample[s].panning/255),t.channel[n].voicevolume=t.channel[n].volume),i=t.channel[n].instrument,a<254){s=t.instrument[i].samplemap[a],t.channel[n].sampleindex=s;var c=a+t.instrument[i].sample[s].relativenote;l=t.calcperiod(t,c,t.instrument[i].sample[s].finetune),t.channel[n].noteon?3!=t.channel[n].command&&5!=t.channel[n].command&&(t.channel[n].note=a,t.channel[n].period=l,t.channel[n].voiceperiod=t.channel[n].period,t.channel[n].flags|=3,t.channel[n].trigramp=0,t.channel[n].trigrampfrom=t.channel[n].currentsample,t.channel[n].samplepos=0,t.channel[n].playdir=1,t.channel[n].vibratowave>3&&(t.channel[n].vibratopos=0),t.channel[n].noteon=1,t.channel[n].fadeoutpos=65535,t.channel[n].volenvpos=0,t.channel[n].panenvpos=0):(t.pattern[e][r+1]&&(t.channel[n].samplepos=0,t.channel[n].playdir=1,t.channel[n].vibratowave>3&&(t.channel[n].vibratopos=0),t.channel[n].noteon=1,t.channel[n].fadeoutpos=65535,t.channel[n].volenvpos=0,t.channel[n].panenvpos=0,t.channel[n].trigramp=0,t.channel[n].trigrampfrom=t.channel[n].currentsample),3!=t.channel[n].command&&5!=t.channel[n].command&&(t.channel[n].note=a,t.channel[n].period=l,t.channel[n].voiceperiod=t.channel[n].period,t.channel[n].flags|=3)),t.channel[n].slideto=l}else 254==a&&(t.channel[n].noteon=0,1&t.instrument[i].voltype||(t.channel[n].voicevolume=0));255!=t.pattern[e][r+2]&&(o=t.pattern[e][r+2])<=64&&(t.channel[n].volume=o,t.channel[n].voicevolume=t.channel[n].volume)},Fasttracker.prototype.process_tick=function(t){t.advance(t);for(var e=0;e<t.channels;e++){var n=t.patterntable[t.position],a=5*t.row*t.channels+5*e;t.channel[e].oldfinalvolume=t.channel[e].finalvolume,2&t.flags&&(t.channel[e].command=t.pattern[n][a+3],t.channel[e].data=t.pattern[n][a+4],14==t.channel[e].command&&208==(240&t.channel[e].data)||t.process_note(t,n,e)),i=t.channel[e].instrument,si=t.channel[e].sampleindex,t.channel[e].noteon&&!t.instrument[i].samples&&(t.channel[e].noteon=0);var s,o=t.pattern[n][a+2];if(o>=80&&o<240&&(t.tick?t.voleffects_t1[(o>>4)-5](t,e,15&o):t.voleffects_t0[(o>>4)-5](t,e,15&o)),t.channel[e].command<36&&(t.tick?t.effects_t1[t.channel[e].command](t,e):(t.effects_t0[t.channel[e].command](t,e),this.songEventListener.onSongEffect&&(t.channel[e].command>0||t.channel[e].data>0)&&this.songEventListener.onSongEffect(e,t.channel[e].command,t.channel[e].data))),(1&t.channel[e].flags||2&t.flags)&&t.channel[e].voiceperiod)s=t.amigaperiods?8287.137*1712/t.channel[e].voiceperiod:8287.137*Math.pow(2,(4608-t.channel[e].voiceperiod)/768),t.channel[e].samplespeed=s/t.samplerate;t.channel[e].vibratopos+=t.channel[e].vibratospeed,t.channel[e].vibratopos&=63,1&t.instrument[i].voltype&&(t.channel[e].volenvpos++,t.channel[e].noteon&&2&t.instrument[i].voltype&&t.channel[e].volenvpos>=t.instrument[i].volsustain&&(t.channel[e].volenvpos=t.instrument[i].volsustain),4&t.instrument[i].voltype&&t.channel[e].volenvpos>=t.instrument[i].volloopend&&(t.channel[e].volenvpos=t.instrument[i].volloopstart),t.channel[e].volenvpos>=t.instrument[i].volenvlen&&(t.channel[e].volenvpos=t.instrument[i].volenvlen),t.channel[e].volenvpos>324&&(t.channel[e].volenvpos=324),!t.channel[e].noteon&&t.channel[e].fadeoutpos&&(t.channel[e].fadeoutpos-=t.instrument[i].volfadeout,t.channel[e].fadeoutpos<0&&(t.channel[e].fadeoutpos=0))),1&t.instrument[i].pantype&&(t.channel[e].panenvpos++,t.channel[e].noteon&&2&t.instrument[i].pantype&&t.channel[e].panenvpos>=t.instrument[i].pansustain&&(t.channel[e].panenvpos=t.instrument[i].pansustain),4&t.instrument[i].pantype&&t.channel[e].panenvpos>=t.instrument[i].panloopend&&(t.channel[e].panenvpos=t.instrument[i].panloopstart),t.channel[e].panenvpos>=t.instrument[i].panenvlen&&(t.channel[e].panenvpos=t.instrument[i].panenvlen),t.channel[e].panenvpos>324&&(t.channel[e].panenvpos=324)),t.channel[e].finalvolume=t.channel[e].voicevolume*t.instrument[i].volenv[t.channel[e].volenvpos]*t.channel[e].fadeoutpos/65536,t.finalpan[e]=t.pan[e]+(t.instrument[i].panenv[t.channel[e].panenvpos]-.5)*(.5*Math.abs(t.pan[e]-.5))*2,t.channel[e].oldfinalvolume!=t.channel[e].finalvolume&&(t.channel[e].volrampfrom=t.channel[e].oldfinalvolume,t.channel[e].volramp=0),t.channel[e].flags=0}t.flags&=112},Fasttracker.prototype.mix=function(e,n,a){var i=new Float32Array(2);if(e.paused||e.endofsong||!e.playing)for(var s=0;s<a;s++){n[0][s]=0,n[1][s]=0;for(var o=0;o<e.chvu.length;o++)e.chvu[o]=0}else for(s=0;s<a;s++){i[0]=0,i[1]=0,e.stt<=0&&e.process_tick(e);for(o=0;o<e.channels;o++){var r=0,l=0,c=0,h=e.channel[o].instrument,p=e.channel[o].sampleindex;if(e.channel[o].noteon||1&e.instrument[h].voltype&&!e.channel[o].noteon&&e.channel[o].fadeoutpos||!e.channel[o].noteon&&e.channel[o].volramp<1){if(e.instrument[h].sample[p].length>e.channel[o].samplepos){r=e.channel[o].lastsample;var f=Math.floor(e.channel[o].samplepos);c=e.instrument[h].sample[p].data[f],f=e.channel[o].samplepos-f,r=(f=e.channel[o].playdir<0?1-f:f)*c+(1-f)*r,r=(f=e.channel[o].trigramp)*r+(1-f)*e.channel[o].trigrampfrom,f+=1/128,e.channel[o].trigramp=Math.min(1,f),e.channel[o].currentsample=r,l=r*(e.channel[o].finalvolume/64),r=(f=e.channel[o].volramp)*l+(1-f)*(r*(e.channel[o].volrampfrom/64)),f+=1/64,e.channel[o].volramp=Math.min(1,f),l=r*(f=e.finalpan[o]),r*=1-f}!e.channel[o].interactiveMute&&e.channel[o].interactiveVolume>0&&(i[0]+=r*e.channel[o].interactiveVolume,i[1]+=l*e.channel[o].interactiveVolume);var u=e.channel[o].samplepos;e.channel[o].samplepos+=e.channel[o].playdir*e.channel[o].samplespeed,1==e.channel[o].playdir?Math.floor(e.channel[o].samplepos)>Math.floor(u)&&(e.channel[o].lastsample=c):Math.floor(e.channel[o].samplepos)<Math.floor(u)&&(e.channel[o].lastsample=c),e.instrument[h].sample[p].looptype?2==e.instrument[h].sample[p].looptype?-1==e.channel[o].playdir?e.channel[o].samplepos<=e.instrument[h].sample[p].loopstart&&(e.channel[o].samplepos+=e.instrument[h].sample[p].loopstart-e.channel[o].samplepos,e.channel[o].playdir=1,e.channel[o].lastsample=e.channel[o].currentsample):e.channel[o].samplepos>=e.instrument[h].sample[p].loopend&&(e.channel[o].samplepos-=e.channel[o].samplepos-e.instrument[h].sample[p].loopend,e.channel[o].playdir=-1,e.channel[o].lastsample=e.channel[o].currentsample):e.channel[o].samplepos>=e.instrument[h].sample[p].loopend&&(e.channel[o].samplepos-=e.instrument[h].sample[p].looplength,e.channel[o].lastsample=e.channel[o].currentsample):e.channel[o].samplepos>=e.instrument[h].sample[p].length&&(e.channel[o].noteon=0)}else e.channel[o].currentsample=0;e.chvu[o]=Math.max(e.chvu[o],Math.abs(r+l))}t=e.volume/64,n[0][s]=i[0]*t,n[1][s]=i[1]*t,e.stt--}},Fasttracker.prototype.effect_vol_t0_60=function(t,e,n){},Fasttracker.prototype.effect_vol_t0_70=function(t,e,n){},Fasttracker.prototype.effect_vol_t0_80=function(t,e,n){t.channel[e].voicevolume-=n,t.channel[e].voicevolume<0&&(t.channel[e].voicevolume=0)},Fasttracker.prototype.effect_vol_t0_90=function(t,e,n){t.channel[e].voicevolume+=n,t.channel[e].voicevolume>64&&(t.channel[e].voicevolume=64)},Fasttracker.prototype.effect_vol_t0_a0=function(t,e,n){t.channel[e].vibratospeed=n},Fasttracker.prototype.effect_vol_t0_b0=function(t,e,n){n&&(t.channel[e].vibratodepth=n),t.effect_t1_4(t,e)},Fasttracker.prototype.effect_vol_t0_c0=function(t,e,n){t.pan[e]=(15&n)/15},Fasttracker.prototype.effect_vol_t0_d0=function(t,e,n){},Fasttracker.prototype.effect_vol_t0_e0=function(t,e,n){},Fasttracker.prototype.effect_vol_t0_f0=function(t,e,n){},Fasttracker.prototype.effect_vol_t1_60=function(t,e,n){t.channel[e].voicevolume-=n,t.channel[e].voicevolume<0&&(t.channel[e].voicevolume=0)},Fasttracker.prototype.effect_vol_t1_70=function(t,e,n){t.channel[e].voicevolume+=n,t.channel[e].voicevolume>64&&(t.channel[e].voicevolume=64)},Fasttracker.prototype.effect_vol_t1_80=function(t,e,n){},Fasttracker.prototype.effect_vol_t1_90=function(t,e,n){},Fasttracker.prototype.effect_vol_t1_a0=function(t,e,n){},Fasttracker.prototype.effect_vol_t1_b0=function(t,e,n){t.effect_t1_4(t,e)},Fasttracker.prototype.effect_vol_t1_c0=function(t,e,n){},Fasttracker.prototype.effect_vol_t1_d0=function(t,e,n){},Fasttracker.prototype.effect_vol_t1_e0=function(t,e,n){},Fasttracker.prototype.effect_vol_t1_f0=function(t,e,n){},Fasttracker.prototype.effect_t0_0=function(t,e){t.channel[e].arpeggio=t.channel[e].data},Fasttracker.prototype.effect_t0_1=function(t,e){t.channel[e].data&&(t.channel[e].slideupspeed=4*t.channel[e].data)},Fasttracker.prototype.effect_t0_2=function(t,e){t.channel[e].data&&(t.channel[e].slidedownspeed=4*t.channel[e].data)},Fasttracker.prototype.effect_t0_3=function(t,e){t.channel[e].data&&(t.channel[e].slidetospeed=4*t.channel[e].data)},Fasttracker.prototype.effect_t0_4=function(t,e){15&t.channel[e].data&&240&t.channel[e].data&&(t.channel[e].vibratodepth=15&t.channel[e].data,t.channel[e].vibratospeed=(240&t.channel[e].data)>>4),t.effect_t1_4(t,e)},Fasttracker.prototype.effect_t0_5=function(t,e){t.effect_t0_a(t,e)},Fasttracker.prototype.effect_t0_6=function(t,e){t.effect_t0_a(t,e)},Fasttracker.prototype.effect_t0_7=function(t,e){},Fasttracker.prototype.effect_t0_8=function(t,e){t.pan[e]=t.channel[e].data/255},Fasttracker.prototype.effect_t0_9=function(t,e){t.channel[e].samplepos=256*t.channel[e].data,t.channel[e].playdir=1,t.channel[e].trigramp=0,t.channel[e].trigrampfrom=t.channel[e].currentsample},Fasttracker.prototype.effect_t0_a=function(t,e){t.channel[e].data&&(t.channel[e].volslide=t.channel[e].data)},Fasttracker.prototype.effect_t0_b=function(t,e){t.breakrow=0,t.patternjump=t.channel[e].data,t.flags|=16},Fasttracker.prototype.effect_t0_c=function(t,e){t.channel[e].voicevolume=t.channel[e].data,t.channel[e].voicevolume<0&&(t.channel[e].voicevolume=0),t.channel[e].voicevolume>64&&(t.channel[e].voicevolume=64)},Fasttracker.prototype.effect_t0_d=function(t,e){t.breakrow=10*((240&t.channel[e].data)>>4)+(15&t.channel[e].data),16&t.flags||(t.patternjump=t.position+1),t.flags|=16},Fasttracker.prototype.effect_t0_e=function(t,e){var n=(240&t.channel[e].data)>>4;t.effects_t0_e[n](t,e)},Fasttracker.prototype.effect_t0_f=function(t,e){t.channel[e].data>32?t.bpm=t.channel[e].data:t.channel[e].data&&(t.speed=t.channel[e].data)},Fasttracker.prototype.effect_t0_g=function(t,e){t.channel[e].data<=64&&(t.volume=t.channel[e].data)},Fasttracker.prototype.effect_t0_h=function(t,e){t.channel[e].data&&(t.globalvolslide=t.channel[e].data)},Fasttracker.prototype.effect_t0_i=function(t,e){},Fasttracker.prototype.effect_t0_j=function(t,e){},Fasttracker.prototype.effect_t0_k=function(t,e){t.channel[e].noteon=0,1&t.instrument[t.channel[e].instrument].voltype||(t.channel[e].voicevolume=0)},Fasttracker.prototype.effect_t0_l=function(t,e){t.channel[e].volenvpos=t.channel[e].data,t.channel[e].panenvpos=t.channel[e].data},Fasttracker.prototype.effect_t0_m=function(t,e){},Fasttracker.prototype.effect_t0_n=function(t,e){},Fasttracker.prototype.effect_t0_o=function(t,e){},Fasttracker.prototype.effect_t0_p=function(t,e){},Fasttracker.prototype.effect_t0_q=function(t,e){},Fasttracker.prototype.effect_t0_r=function(t,e){},Fasttracker.prototype.effect_t0_s=function(t,e){},Fasttracker.prototype.effect_t0_t=function(t,e){},Fasttracker.prototype.effect_t0_u=function(t,e){},Fasttracker.prototype.effect_t0_v=function(t,e){},Fasttracker.prototype.effect_t0_w=function(t,e){},Fasttracker.prototype.effect_t0_x=function(t,e){},Fasttracker.prototype.effect_t0_y=function(t,e){},Fasttracker.prototype.effect_t0_z=function(t,e){},Fasttracker.prototype.effect_t0_e0=function(t,e){},Fasttracker.prototype.effect_t0_e1=function(t,e){t.channel[e].period-=15&t.channel[e].data,t.channel[e].period<113&&(t.channel[e].period=113)},Fasttracker.prototype.effect_t0_e2=function(t,e){t.channel[e].period+=15&t.channel[e].data,t.channel[e].period>856&&(t.channel[e].period=856),t.channel[e].flags|=1},Fasttracker.prototype.effect_t0_e3=function(t,e){},Fasttracker.prototype.effect_t0_e4=function(t,e){t.channel[e].vibratowave=7&t.channel[e].data},Fasttracker.prototype.effect_t0_e5=function(t,e){},Fasttracker.prototype.effect_t0_e6=function(t,e){15&t.channel[e].data?(t.loopcount?t.loopcount--:t.loopcount=15&t.channel[e].data,t.loopcount&&(t.flags|=64)):t.looprow=t.row},Fasttracker.prototype.effect_t0_e7=function(t,e){},Fasttracker.prototype.effect_t0_e8=function(t,e){t.syncqueue.unshift(15&t.channel[e].data)},Fasttracker.prototype.effect_t0_e9=function(t,e){},Fasttracker.prototype.effect_t0_ea=function(t,e){t.channel[e].voicevolume+=15&t.channel[e].data,t.channel[e].voicevolume>64&&(t.channel[e].voicevolume=64)},Fasttracker.prototype.effect_t0_eb=function(t,e){t.channel[e].voicevolume-=15&t.channel[e].data,t.channel[e].voicevolume<0&&(t.channel[e].voicevolume=0)},Fasttracker.prototype.effect_t0_ec=function(t,e){},Fasttracker.prototype.effect_t0_ed=function(t,e){t.tick==(15&t.channel[e].data)&&t.process_note(t,t.patterntable[t.position],e)},Fasttracker.prototype.effect_t0_ee=function(t,e){t.patterndelay=15&t.channel[e].data,t.patternwait=0},Fasttracker.prototype.effect_t0_ef=function(t,e){},Fasttracker.prototype.effect_t1_0=function(t,e){if(t.channel[e].data){var n=t.channel[e].instrument,a=t.channel[e].note;t.tick%3==1&&(a+=t.channel[e].arpeggio>>4),t.tick%3==2&&(a+=15&t.channel[e].arpeggio);var i=t.channel[e].sampleindex;t.channel[e].voiceperiod=t.calcperiod(t,a+t.instrument[n].sample[i].relativenote,t.instrument[n].sample[i].finetune),t.channel[e].flags|=1}},Fasttracker.prototype.effect_t1_1=function(t,e){t.channel[e].voiceperiod-=t.channel[e].slideupspeed,t.channel[e].voiceperiod<1&&(t.channel[e].voiceperiod+=65535),t.channel[e].flags|=3},Fasttracker.prototype.effect_t1_2=function(t,e){t.channel[e].voiceperiod+=t.channel[e].slidedownspeed,t.channel[e].voiceperiod>7680&&(t.channel[e].voiceperiod=7680),t.channel[e].flags|=3},Fasttracker.prototype.effect_t1_3=function(t,e){t.channel[e].voiceperiod<t.channel[e].slideto&&(t.channel[e].voiceperiod+=t.channel[e].slidetospeed,t.channel[e].voiceperiod>t.channel[e].slideto&&(t.channel[e].voiceperiod=t.channel[e].slideto)),t.channel[e].voiceperiod>t.channel[e].slideto&&(t.channel[e].voiceperiod-=t.channel[e].slidetospeed,t.channel[e].voiceperiod<t.channel[e].slideto&&(t.channel[e].voiceperiod=t.channel[e].slideto)),t.channel[e].flags|=3},Fasttracker.prototype.effect_t1_4=function(t,e){var n=t.vibratotable[3&t.channel[e].vibratowave][t.channel[e].vibratopos]/63,a=t.channel[e].vibratodepth*n;t.channel[e].voiceperiod+=a,t.channel[e].flags|=1},Fasttracker.prototype.effect_t1_5=function(t,e){t.effect_t1_3(t,e),t.effect_t1_a(t,e)},Fasttracker.prototype.effect_t1_6=function(t,e){t.effect_t1_4(t,e),t.effect_t1_a(t,e)},Fasttracker.prototype.effect_t1_7=function(t,e){},Fasttracker.prototype.effect_t1_8=function(t,e){},Fasttracker.prototype.effect_t1_9=function(t,e){},Fasttracker.prototype.effect_t1_a=function(t,e){15&t.channel[e].volslide||(t.channel[e].voicevolume+=t.channel[e].volslide>>4,t.channel[e].voicevolume>64&&(t.channel[e].voicevolume=64)),240&t.channel[e].volslide||(t.channel[e].voicevolume-=15&t.channel[e].volslide,t.channel[e].voicevolume<0&&(t.channel[e].voicevolume=0))},Fasttracker.prototype.effect_t1_b=function(t,e){},Fasttracker.prototype.effect_t1_c=function(t,e){},Fasttracker.prototype.effect_t1_d=function(t,e){},Fasttracker.prototype.effect_t1_e=function(t,e){var n=(240&t.channel[e].data)>>4;t.effects_t1_e[n](t,e)},Fasttracker.prototype.effect_t1_f=function(t,e){},Fasttracker.prototype.effect_t1_g=function(t,e){},Fasttracker.prototype.effect_t1_h=function(t,e){15&t.globalvolslide||(t.volume+=t.globalvolslide>>4,t.volume>64&&(t.volume=64)),240&t.globalvolslide||(t.volume-=15&t.globalvolslide,t.volume<0&&(t.volume=0))},Fasttracker.prototype.effect_t1_i=function(t,e){},Fasttracker.prototype.effect_t1_j=function(t,e){},Fasttracker.prototype.effect_t1_k=function(t,e){},Fasttracker.prototype.effect_t1_l=function(t,e){},Fasttracker.prototype.effect_t1_m=function(t,e){},Fasttracker.prototype.effect_t1_n=function(t,e){},Fasttracker.prototype.effect_t1_o=function(t,e){},Fasttracker.prototype.effect_t1_p=function(t,e){},Fasttracker.prototype.effect_t1_q=function(t,e){},Fasttracker.prototype.effect_t1_r=function(t,e){},Fasttracker.prototype.effect_t1_s=function(t,e){},Fasttracker.prototype.effect_t1_t=function(t,e){},Fasttracker.prototype.effect_t1_u=function(t,e){},Fasttracker.prototype.effect_t1_v=function(t,e){},Fasttracker.prototype.effect_t1_w=function(t,e){},Fasttracker.prototype.effect_t1_x=function(t,e){},Fasttracker.prototype.effect_t1_y=function(t,e){},Fasttracker.prototype.effect_t1_z=function(t,e){},Fasttracker.prototype.effect_t1_e0=function(t,e){},Fasttracker.prototype.effect_t1_e1=function(t,e){},Fasttracker.prototype.effect_t1_e2=function(t,e){},Fasttracker.prototype.effect_t1_e3=function(t,e){},Fasttracker.prototype.effect_t1_e4=function(t,e){},Fasttracker.prototype.effect_t1_e5=function(t,e){},Fasttracker.prototype.effect_t1_e6=function(t,e){},Fasttracker.prototype.effect_t1_e7=function(t,e){},Fasttracker.prototype.effect_t1_e8=function(t,e){},Fasttracker.prototype.effect_t1_e9=function(t,e){t.tick%(15&t.channel[e].data)==0&&(t.channel[e].samplepos=0,t.channel[e].playdir=1,t.channel[e].trigramp=0,t.channel[e].trigrampfrom=t.channel[e].currentsample,t.channel[e].fadeoutpos=65535,t.channel[e].volenvpos=0,t.channel[e].panenvpos=0)},Fasttracker.prototype.effect_t1_ea=function(t,e){},Fasttracker.prototype.effect_t1_eb=function(t,e){},Fasttracker.prototype.effect_t1_ec=function(t,e){t.tick==(15&t.channel[e].data)&&(t.channel[e].voicevolume=0)},Fasttracker.prototype.effect_t1_ed=function(t,e){t.effect_t0_ed(t,e)},Fasttracker.prototype.effect_t1_ee=function(t,e){},Fasttracker.prototype.effect_t1_ef=function(t,e){};class ModInteractivePlayer{constructor(t=void 0){this.mod=t||new Modplayer,this.mod.onSongRowChange=this.onRowChange.bind(this),this.mod.onSongPatternChange=this.onPatternChange.bind(this),this.rowDelayedActions=[],this.patternDelayedActions=[]}onRowChange(){const t=this.rowDelayedActions;this.rowDelayedActions=[],t.forEach((t=>this.runAction(t)))}onPatternChange(){const t=this.patternDelayedActions;this.patternDelayedActions=[],t.forEach((t=>this.runAction(t)))}load(t){const e=this.mod.onReady,n=this.mod.onFailure;let a=null;const i=new Promise((t=>a=t)),s=t=>{this.mod.onReady=e,this.mod.onFailure=n,a(t)};return this.mod.onReady=()=>s(!0),this.mod.onFailure=()=>s(!1),this.mod.load(t)||resultResolve(!1),i}play(t=!1){this.mod.setrepeat(t),this.mod.play()}runAction(t){switch(t.type){case"stop":this.mod.stop();break;case"setChannelMute":{const e=this.mod.player.channel[t.channelIndex];if(!e)return;e.interactiveMute=t.muted;break}case"setChannelVolume":{const e=this.mod.player.channel[t.channelIndex];if(!e)return;e.interactiveVolume=t.volume||1;break}case"fadechannel":{const e=this.mod.player.channel[t.channelIndex];if(!e)return;if(null==t.originalVolume){if(!!t.fadeIn!=!!e.interactiveMute)return;t.originalVolume=e.interactiveVolume,t.volumeChangePerRow=t.originalVolume/(t.speed||64),t.fadeIn?(e.interactiveVolume=0,e.interactiveMute=!1):t.volumeChangePerRow*=-1}e.interactiveVolume+=t.volumeChangePerRow,!t.fadeIn&&e.interactiveVolume<=0?(e.interactiveMute=!0,e.interactiveVolume=t.originalVolume):t.fadeIn&&e.interactiveVolume>=t.originalVolume?e.interactiveVolume=t.originalVolume:this.rowDelayedActions.push(t);break}}}stop(t=!1){const e={type:"stop"};t?this.patternDelayedActions.push(e):this.runAction(e)}setChannelMute(t,e=!0,n=!1){const a={type:"setChannelMute",channelIndex:t,muted:e};n?this.patternDelayedActions.push(a):this.runAction(a)}setChannelVolume(t,e=1,n=!1){const a={type:"setChannelVolume",channelIndex:t,volume:e};n?this.patternDelayedActions.push(a):this.runAction(a)}fadeChannel(t,e=!1,n=64,a=!1){const i={type:"fadechannel",channelIndex:t,fadeIn:e,speed:n};a?this.patternDelayedActions.push(i):this.runAction(i)}}